<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Estimate Approval — Mubasher One</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html{scroll-behavior:smooth}</style>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <main class="max-w-3xl mx-auto p-6">
    <div class="mb-6">
      <a href="/" class="text-sm text-neutral-500 hover:underline">&larr; Back to Home</a>
    </div>

    <div id="card" class="rounded-2xl bg-white shadow-sm border border-neutral-200 p-6">
      <h1 class="text-2xl font-semibold mb-2" id="title">Estimate</h1>
      <p class="text-sm text-neutral-600 mb-6" id="subtitle">Loading…</p>

      <div id="details" class="grid md:grid-cols-2 gap-4 mb-6 hidden">
        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">Customer</div>
          <div class="font-medium" id="customer"></div>
        </div>
        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">Vehicle</div>
          <div class="font-medium" id="vehicle"></div>
        </div>

        <!-- Work Description -->
        <div class="rounded-xl border p-4 md:col-span-2">
          <div class="text-xs text-neutral-500">Work Description</div>
          <div class="font-medium whitespace-pre-wrap" id="work_description"></div>
        </div>

        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">Subtotal</div>
          <div class="font-medium" id="subtotal"></div>
        </div>
        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">VAT</div>
          <div class="font-medium" id="vat"></div>
        </div>
        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">Total</div>
          <div class="font-semibold text-lg" id="total"></div>
        </div>
        <div class="rounded-xl border p-4">
          <div class="text-xs text-neutral-500">Status</div>
          <div class="font-medium" id="status"></div>
        </div>
      </div>

      <label class="block text-sm text-neutral-600 mb-2">Add a note (optional)</label>
      <textarea id="note" class="w-full border rounded-xl p-3 mb-4" rows="3" placeholder="Any comments…"></textarea>

      <div class="flex gap-3">
        <button id="approveBtn" class="px-5 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Approve</button>
        <button id="rejectBtn" class="px-5 py-3 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Reject</button>
      </div>

      <div id="msg" class="mt-4 text-sm"></div>
    </div>
  </main>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxoMvrYXR6XnDBe9NHrT6qQY2_sM8V9Kf2dKJ0fhp-8Ohx4rIopBdSdMjZ6sJqTCud4Ow/exec';

function qs(k){ return new URLSearchParams(location.search).get(k); }
const estimateId = qs('id');
const token = qs('token');

const els = {
  title: document.getElementById('title'),
  subtitle: document.getElementById('subtitle'),
  details: document.getElementById('details'),
  customer: document.getElementById('customer'),
  vehicle: document.getElementById('vehicle'),
  work_description: document.getElementById('work_description'),
  subtotal: document.getElementById('subtotal'),
  vat: document.getElementById('vat'),
  total: document.getElementById('total'),
  status: document.getElementById('status'),
  approve: document.getElementById('approveBtn'),
  reject: document.getElementById('rejectBtn'),
  note: document.getElementById('note'),
  msg: document.getElementById('msg')
};

async function loadEstimate(){
  if(!estimateId || !token){
    els.subtitle.textContent = 'Missing estimate link parameters.';
    return;
  }
  try{
    const url = `${SCRIPT_URL}?action=get&id=${encodeURIComponent(estimateId)}&token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { headers: { 'Content-Type':'application/json' }});
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    const e = data.estimate;
    els.title.textContent = `Estimate ${e.estimate_id}`;
    els.subtitle.textContent = 'Please review the details below:';
    els.customer.textContent = e.customer_name || '';
    els.vehicle.textContent = e.vehicle || '';
    els.work_description.textContent = e.work_description || '';
    els.subtotal.textContent = e.subtotal || '';
    els.vat.textContent = e.vat || '';
    els.total.textContent = e.total || '';
    els.status.textContent = e.status || '';
    els.details.classList.remove('hidden');

    const final = String(e.status || '').toUpperCase();
    if (final === 'APPROVED' || final === 'REJECTED'){
      els.approve.disabled = true;
      els.reject.disabled = true;
      els.msg.textContent = `This estimate is already ${final.toLowerCase()}.`;
    }
  }catch(err){
    els.subtitle.textContent = 'Sorry, this estimate could not be loaded.';
    console.error(err);
  }
}

async function decide(decision){
  els.msg.textContent = 'Submitting…';
  try{
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        action:'decide',
        id: estimateId,
        token,
        decision,
        note: els.note.value||''
      })
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Failed');
    els.msg.textContent = decision === 'APPROVED' ? '✅ Approved. Thank you.' : '❌ Rejected. We’ll review and contact you.';
    els.approve.disabled = true;
    els.reject.disabled = true;
  }catch(err){
    els.msg.textContent = err.message?.includes('Already') ? err.message : 'There was an issue saving your decision.';
    console.error(err);
  }
}

els.approve.addEventListener('click', ()=>decide('APPROVED'));
els.reject.addEventListener('click', ()=>decide('REJECTED'));

loadEstimate();
</script>
</body>
</html>
